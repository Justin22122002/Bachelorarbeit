import json
from typing import override, List
from malwareAnalysis.malwareAnalysisTool.analysis.AnalysisStrategy import AnalysisStrategy
from malwareAnalysis.malwareAnalysisTool.analysis.models.OperatingSystem import OperatingSystem
from malwareAnalysis.malwareAnalysisTool.analysis.models.data.PsxViewData import PsxViewData
from malwareAnalysis.malwareAnalysisTool.analysis.models.result.PsxViewSummary import PsxViewSummary

class PsxViewStrategy(AnalysisStrategy[PsxViewData, PsxViewSummary]):
    """
    The `psxview` plugin analyzes various processes and threads to identify inconsistencies
    and potential hidden processes. Useful for forensic analysis and detecting malicious activities.
    """

    @override
    def get_command(self) -> dict[OperatingSystem, str]:
        return {OperatingSystem.WINDOWS: 'windows.psxview'}


    @override
    def analyze_output(self, file_path: str = None) -> None:
        path_to_use: str = file_path if file_path else self.get_file_path()

        try:
            with open(path_to_use, 'r') as file:
                data: list[dict] = json.load(file)

            self.analyzer_output: list[PsxViewData] = self.parse_psxview_data(data)
            self.analyzer_summary: PsxViewSummary = self.summarize_psxview_data()

        except json.JSONDecodeError as e:
            print(f"Error: Failed to parse JSON file at {path_to_use}. {e}")
            self.analyzer_output = []
            self.analyzer_summary = PsxViewSummary(
                psxview_not_in_pslist=0,
                psxview_not_in_eprocess_pool=0,
                psxview_not_in_ethread_pool=0,
                psxview_not_in_pspcid_list=0,
                psxview_not_in_csrss_handles=0,
                psxview_not_in_session=0,
                psxview_not_in_deskthrd=0,
                psxview_not_in_pslist_false_avg=0.0,
                psxview_not_in_eprocess_pool_false_avg=0.0,
                psxview_not_in_ethread_pool_false_avg=0.0,
                psxview_not_in_pspcid_list_false_avg=0.0,
                psxview_not_in_csrss_handles_false_avg=0.0,
                psxview_not_in_session_false_avg=0.0,
                psxview_not_in_deskthrd_false_avg=0.0,
            )
        

    @staticmethod
    def parse_psxview_data(data: list[dict]) -> List[PsxViewData]:
        """
        Parse the JSON output to create a list of PsxViewData instances.
        """
        def parse(data_item: dict) -> PsxViewData:
            children: list[PsxViewData] = [parse(child) for child in data_item.get('__children', [])]

            return PsxViewData(
                name=data_item.get('Name', ''),
                pid=data_item.get('PID', 0),
                exit_time=data_item.get('Exit Time"', None),
                Offset=data_item.get('Offset(Virtual)', 0),
                csrss=data_item.get('csrss', False),
                pslist=data_item.get('pslist', False),
                psscan=data_item.get('psscan', False),
                thrdscan=data_item.get('thrdscan', False),
                children=children
            )

        return [parse(item) for item in data]

    def summarize_psxview_data(self) -> PsxViewSummary:
        """
        Aggregates metrics from the parsed psxview data and creates a PsxViewSummary instance.
        """

        total_processes: int = len(self.analyzer_output)

        if total_processes == 0:
            # Handle edge case with no processes to avoid division by zero
            return PsxViewSummary(
                psxview_not_in_pslist=0,
                psxview_not_in_eprocess_pool=0,
                psxview_not_in_ethread_pool=0,
                psxview_not_in_pspcid_list=0,
                psxview_not_in_csrss_handles=0,
                psxview_not_in_session=0,
                psxview_not_in_deskthrd=0,
                psxview_not_in_pslist_false_avg=0.0,
                psxview_not_in_eprocess_pool_false_avg=0.0,
                psxview_not_in_ethread_pool_false_avg=0.0,
                psxview_not_in_pspcid_list_false_avg=0.0,
                psxview_not_in_csrss_handles_false_avg=0.0,
                psxview_not_in_session_false_avg=0.0,
                psxview_not_in_deskthrd_false_avg=0.0,
            )

        # Initialize counters for various process states
        not_in_pslist: int = sum(1 for p in self.analyzer_output if not p.pslist)
        not_in_csrss_handles: int = sum(1 for p in self.analyzer_output if not p.csrss)
        not_in_eprocess_pool: int = sum(1 for p in self.analyzer_output if not p.psscan)
        not_in_ethread_pool: int = sum(1 for p in self.analyzer_output if not p.thrdscan)
        not_in_pspcid_list: int = sum(1 for p in self.analyzer_output if not p.exit_time)
        not_in_session: int = sum(1 for p in self.analyzer_output if not p.Offset)
        not_in_deskthrd: int = sum(1 for p in self.analyzer_output if not p.children)

        # Calculate averages
        avg_not_in_pslist: float = not_in_pslist / total_processes
        avg_not_in_csrss_handles: float = not_in_csrss_handles / total_processes
        avg_not_in_eprocess_pool: float = not_in_eprocess_pool / total_processes
        avg_not_in_ethread_pool: float = not_in_ethread_pool / total_processes
        avg_not_in_pspcid_list: float = not_in_pspcid_list / total_processes
        avg_not_in_session: float = not_in_session / total_processes
        avg_not_in_deskthrd: float = not_in_deskthrd / total_processes

        # Create and return summary object
        return PsxViewSummary(
            psxview_not_in_pslist=not_in_pslist,
            psxview_not_in_eprocess_pool=not_in_eprocess_pool,
            psxview_not_in_ethread_pool=not_in_ethread_pool,
            psxview_not_in_pspcid_list=not_in_pspcid_list,
            psxview_not_in_csrss_handles=not_in_csrss_handles,
            psxview_not_in_session=not_in_session,
            psxview_not_in_deskthrd=not_in_deskthrd,
            psxview_not_in_pslist_false_avg=avg_not_in_pslist,
            psxview_not_in_eprocess_pool_false_avg=avg_not_in_eprocess_pool,
            psxview_not_in_ethread_pool_false_avg=avg_not_in_ethread_pool,
            psxview_not_in_pspcid_list_false_avg=avg_not_in_pspcid_list,
            psxview_not_in_csrss_handles_false_avg=avg_not_in_csrss_handles,
            psxview_not_in_session_false_avg=avg_not_in_session,
            psxview_not_in_deskthrd_false_avg=avg_not_in_deskthrd,
        )

