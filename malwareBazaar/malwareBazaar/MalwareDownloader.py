from malwareBazaar.MalwareBazaarAPI import MalwareBazaarAPI
from malwareBazaar.reader.CSVReader import CSVReader


class MalwareDownloader:
    def __init__(
            self, csv_loader: CSVReader,
            api: MalwareBazaarAPI,
            location: str
    ):
        self.csv_loader: CSVReader = csv_loader
        self.api: MalwareBazaarAPI = api
        self.location: str = location

    def fetch_samples(self) -> None:
        """
        Load data from CSVs and download the files based on the SHA256 hash.
        """
        data: dict[str, list[dict[str, str]]] = self.csv_loader.load_data()

        for tag, samples in data.items():
            print(f"Loaded data for {tag}:")
            print(len(samples))
            for sample in samples:
                sha256_hash: str = sample.get("sha256_hash", "") + "_" + tag
                file_name: str = sample.get("file_name", "")
                if sha256_hash:
                    self.api.download_file(self.location, sha256_hash, file_name, tag)