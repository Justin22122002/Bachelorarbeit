import csv
import os


class CSVWriter:
    def __init__(self, folder: str):
        self.folder: str = folder
        if not os.path.exists(folder):
            os.makedirs(folder)

    def save(self, data: list[dict[str, str]], file_name: str, file_type_filter: str = "exe", limit: int = 100) -> None:
        file_path: str = os.path.join(self.folder, file_name)
        headers: list[str] = ["sha256_hash", "file_type", "tags", "signature", "file_name"]
        saved_count: int = 0

        with open(file_path, mode='w', newline='', encoding='utf-8') as file:
            writer: csv.DictWriter = csv.DictWriter(file, fieldnames=headers)
            writer.writeheader()

            for item in data:
                if saved_count >= limit:
                    print(f"Limit of {limit} samples reached. Stopping save process.")
                    break
                if item.get("file_type", "").lower() == file_type_filter.lower():
                    writer.writerow({
                        "sha256_hash": item.get("sha256_hash", ""),
                        "file_type": item.get("file_type", ""),
                        "tags": ', '.join(item.get("tags", [])) if item.get("tags") else "",
                        "signature": item.get("signature", ""),
                        "file_name": item.get("file_name", "")
                    })
                    saved_count += 1